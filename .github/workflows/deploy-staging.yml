---
name: Deploy Staging

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (git SHA)"
        required: true
        default: latest
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write

env:
  NAMESPACE: flowforge
  REGISTRY: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_STAGING }}/flowforge

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Resolve image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER_NAME }} \
            --region ${{ vars.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_STAGING }}

      - name: Deploy backend
        run: |
          kubectl set image deployment/backend \
            backend=${{ env.REGISTRY }}/backend:${{ steps.tag.outputs.tag }} \
            -n ${{ env.NAMESPACE }}

      - name: Deploy frontend
        run: |
          kubectl set image deployment/frontend \
            frontend=${{ env.REGISTRY }}/frontend:${{ steps.tag.outputs.tag }} \
            -n ${{ env.NAMESPACE }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Health check
        run: |
          for i in $(seq 1 10); do
            status=$(curl -s -o /dev/null -w '%{http_code}' https://staging.flowforge.io/health/ready || true)
            if [ "$status" = "200" ]; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i: status=$status, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 10 attempts"
          exit 1
