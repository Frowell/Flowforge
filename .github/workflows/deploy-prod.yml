---
name: Deploy Prod

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (must be a git SHA, not 'latest')"
        required: true

permissions:
  contents: read
  id-token: write

env:
  NAMESPACE: flowforge
  REGISTRY: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_PROD }}/flowforge

jobs:
  deploy:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Validate image tag
        run: |
          if [ "${{ inputs.image_tag }}" = "latest" ]; then
            echo "::error::Deploying 'latest' to prod is not allowed. Specify an exact git SHA."
            exit 1
          fi

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER_NAME }} \
            --region ${{ vars.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_PROD }}

      - name: Deploy backend
        run: |
          kubectl set image deployment/backend \
            backend=${{ env.REGISTRY }}/backend:${{ inputs.image_tag }} \
            -n ${{ env.NAMESPACE }}

      - name: Deploy frontend
        run: |
          kubectl set image deployment/frontend \
            frontend=${{ env.REGISTRY }}/frontend:${{ inputs.image_tag }} \
            -n ${{ env.NAMESPACE }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Smoke test
        run: |
          for i in $(seq 1 10); do
            status=$(curl -s -o /dev/null -w '%{http_code}' https://flowforge.io/health/ready || true)
            if [ "$status" = "200" ]; then
              echo "Smoke test passed"
              exit 0
            fi
            echo "Attempt $i: status=$status, retrying in 10s..."
            sleep 10
          done
          echo "Smoke test failed after 10 attempts"
          exit 1
