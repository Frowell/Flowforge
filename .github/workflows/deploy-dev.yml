---
name: Deploy Dev

on:
  workflow_run:
    workflows: [Build]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write

env:
  NAMESPACE: flowforge
  REGISTRY: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_DEV }}/flowforge

jobs:
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: dev

    steps:
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gke-gcloud-auth-plugin

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER_NAME }} \
            --region ${{ vars.GCP_REGION }} \
            --project ${{ vars.GCP_PROJECT_DEV }}

      - name: Deploy backend
        run: |
          kubectl set image deployment/backend \
            backend=${{ env.REGISTRY }}/backend:${{ github.event.workflow_run.head_sha }} \
            -n ${{ env.NAMESPACE }}

      - name: Deploy frontend
        run: |
          kubectl set image deployment/frontend \
            frontend=${{ env.REGISTRY }}/frontend:${{ github.event.workflow_run.head_sha }} \
            -n ${{ env.NAMESPACE }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Health check
        run: |
          for i in $(seq 1 10); do
            status=$(curl -s -o /dev/null -w '%{http_code}' https://dev.flowforge.io/health/ready || true)
            if [ "$status" = "200" ]; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt $i: status=$status, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 10 attempts"
          exit 1
