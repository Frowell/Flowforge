# This job runs once to set up Materialize sources and views.
# It must run AFTER both Materialize and Redpanda are healthy.
# Trigger manually via Tilt or: kubectl apply -f this-file.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: init-materialize
  namespace: flowforge
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-materialize
          image: postgres:16
          command:
            - bash
            - -c
            - |
              until pg_isready -h materialize.flowforge.svc.cluster.local -p 6875 -U materialize; do
                echo "Waiting for Materialize..."
                sleep 2
              done
        - name: wait-for-redpanda
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              until curl -sf http://redpanda.flowforge.svc.cluster.local:9644/v1/cluster/health_overview | grep -q '"is_healthy":true'; do
                echo "Waiting for Redpanda..."
                sleep 2
              done
      containers:
        - name: init
          image: postgres:16
          command:
            - bash
            - -c
            - |
              set -e

              echo "=== Creating Materialize sources ==="
              psql -h materialize.flowforge.svc.cluster.local -p 6875 -U materialize <<'EOF'
              CREATE CONNECTION IF NOT EXISTS redpanda_conn TO KAFKA (
                  BROKER 'redpanda.flowforge.svc.cluster.local:29092',
                  SECURITY PROTOCOL PLAINTEXT
              );

              CREATE SOURCE IF NOT EXISTS raw_trades_source
                FROM KAFKA CONNECTION redpanda_conn (TOPIC 'raw.trades')
                FORMAT JSON
                INCLUDE TIMESTAMP;

              CREATE SOURCE IF NOT EXISTS raw_quotes_source
                FROM KAFKA CONNECTION redpanda_conn (TOPIC 'raw.quotes')
                FORMAT JSON
                INCLUDE TIMESTAMP;
              EOF

              echo "=== Creating staging views ==="
              psql -h materialize.flowforge.svc.cluster.local -p 6875 -U materialize <<'EOF'
              CREATE VIEW IF NOT EXISTS raw_trades_parsed AS
              SELECT
                  (data->>'trade_id')::TEXT AS trade_id,
                  (data->>'event_time')::TIMESTAMPTZ AS event_time,
                  (data->>'symbol')::TEXT AS symbol,
                  (data->>'side')::TEXT AS side,
                  (data->>'quantity')::NUMERIC AS quantity,
                  (data->>'price')::NUMERIC AS price,
                  (data->>'quantity')::NUMERIC * (data->>'price')::NUMERIC AS notional
              FROM raw_trades_source;

              CREATE VIEW IF NOT EXISTS raw_quotes_parsed AS
              SELECT
                  (data->>'symbol')::TEXT AS symbol,
                  (data->>'event_time')::TIMESTAMPTZ AS event_time,
                  (data->>'bid')::NUMERIC AS bid,
                  (data->>'ask')::NUMERIC AS ask,
                  (data->>'bid_size')::NUMERIC AS bid_size,
                  (data->>'ask_size')::NUMERIC AS ask_size,
                  ((data->>'bid')::NUMERIC + (data->>'ask')::NUMERIC) / 2 AS mid_price
              FROM raw_quotes_source;
              EOF

              echo "=== Creating materialized views ==="
              psql -h materialize.flowforge.svc.cluster.local -p 6875 -U materialize <<'EOF'
              CREATE MATERIALIZED VIEW IF NOT EXISTS live_positions AS
              SELECT
                  symbol,
                  SUM(CASE WHEN side = 'BUY' THEN quantity ELSE -quantity END) AS net_qty,
                  SUM(CASE WHEN side = 'BUY' THEN quantity * price ELSE -quantity * price END) AS net_notional,
                  COUNT(*) AS trade_count,
                  MAX(event_time) AS last_update
              FROM raw_trades_parsed
              GROUP BY symbol;

              CREATE MATERIALIZED VIEW IF NOT EXISTS live_quotes AS
              SELECT DISTINCT ON (symbol)
                  symbol,
                  bid,
                  ask,
                  mid_price,
                  bid_size,
                  ask_size,
                  event_time AS last_update
              FROM raw_quotes_parsed
              ORDER BY symbol, event_time DESC;

              CREATE MATERIALIZED VIEW IF NOT EXISTS live_pnl AS
              SELECT
                  p.symbol,
                  p.net_qty,
                  p.net_notional,
                  q.mid_price,
                  (p.net_qty * q.mid_price) - p.net_notional AS unrealized_pnl,
                  GREATEST(p.last_update, q.last_update) AS as_of
              FROM live_positions p
              JOIN live_quotes q ON p.symbol = q.symbol;
              EOF

              echo "=== Materialize initialization complete ==="
